generator client {
  provider     = "prisma-client"
  output       = "client/generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String  @id @default(uuid()) @db.Uuid
  email            String  @unique
  username         String  @unique
  passwordHash     String
  refreshTokenHash String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews  Review[]
  comments Comment[]
  votes    Vote[]
}

model Movie {
  id            String @id @default(uuid()) @db.Uuid
  tmdbId        Int    @unique
  title         String
  year          Int
  canonicalSlug String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews Review[]
}

model Review {
  id         String @id @default(uuid()) @db.Uuid
  content    String
  rating     Float
  totalVotes Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movie   Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)
  movieId String @db.Uuid

  reviewer   User   @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewerId String @db.Uuid

  comments Comment[] @relation("ReviewComments")
  votes    Vote[]
}

model Comment {
  id         String @id @default(uuid()) @db.Uuid
  content    String
  totalVotes Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  commenter   User   @relation(fields: [commenterId], references: [id], onDelete: Cascade)
  commenterId String @db.Uuid

  review   Review @relation("ReviewComments", fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId String @db.Uuid

  parent   Comment? @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  parentId String?  @db.Uuid

  children Comment[] @relation("CommentToComment")

  votes Vote[]
}

model Vote {
  id    String @id @default(uuid()) @db.Uuid
  value Int // 1 or -1 for up/down

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid

  review   Review? @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reviewId String? @db.Uuid

  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?  @db.Uuid

  // NOTE: Custom DB constraint added in migration to enforce that
  // exactly one of reviewId or commentId is set.

  @@unique([userId, reviewId])
  @@unique([userId, commentId])
}
